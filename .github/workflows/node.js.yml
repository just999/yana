# name: Node.js CI

# on:
#   push:
#     branches: [ 'main' ]
#   pull_request:
#     branches: [ 'main' ]

# jobs:
#   build:
#     runs-on: self-hosted

#     strategy:
#       matrix:
#         node-version: [ 22.x ]

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v4

#     - name: Use Node.js ${{ matrix.node-version }}
#       uses: actions/setup-node@v4
#       with:
#         node-version: ${{ matrix.node-version }}
#         cache: 'npm'

#     - name: Cache node modules
#       uses: actions/cache@v4
#       with:
#         path: ~/.npm
#         key: ${{ runner.os }}-node-${{ hashFiles('**/package-lock.json') }}
#         restore-keys: |
#           ${{ runner.os }}-node-

#     - name: Cache Next.js build
#       uses: actions/cache@v4
#       with:
#         path: |
#           ${{ github.workspace }}/.next/cache
#         key: ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-${{ hashFiles('**/{pages,app,components,lib,utils}/**/*.{js,jsx,ts,tsx}', 'next.config.*', 'tailwind.config.*', 'tsconfig.json') }}
#         restore-keys: |
#           ${{ runner.os }}-nextjs-${{ hashFiles('**/package-lock.json') }}-
#           ${{ runner.os }}-nextjs-

#     - name: Install dependencies
#       run: npm ci

#     - name: Create production environment file
#       run: |
#         cat > .env.production << EOF
#         NEXT_URL=${{ secrets.NEXT_URL }}
#         ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
#         DATABASE_URL=${{ secrets.DATABASE_URL }}
#         GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
#         GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
#         NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
#         RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
#         UPLOADTHING_APPID=${{ secrets.UPLOADTHING_APPID }}
#         UPLOADTHING_SECRET=${{ secrets.UPLOADTHING_SECRET }}
#         UPLOADTHING_TOKEN=${{ secrets.UPLOADTHING_TOKEN }}
#         ITS_GITHUB_ID=${{ secrets.ITS_GITHUB_ID }}
#         ITS_GITHUB_SECRET=${{ secrets.ITS_GITHUB_SECRET }}
#         AUTH_TRUST_HOST=${{ secrets.AUTH_TRUST_HOST }}
#         NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
#         EOF

#     - name: Verify environment setup
#       run: |
#         echo "Environment file created"
#         ls -la .env.production

#     - name: Run database migrations
#       run: |
#         if [ -f "prisma/schema.prisma" ]; then
#           npx prisma generate
#           npx prisma db push --accept-data-loss || echo "Migration skipped"
#         fi
#       env:
#         DATABASE_URL: ${{ secrets.DATABASE_URL }}

#     - name: Build Next.js application
#       run: npm run build
#       env:
#         NODE_ENV: production

#     - name: Check build artifacts
#       run: |
#         ls -la .next/ || echo "No .next directory found"
#         if [ -d ".next" ]; then
#           du -sh .next/ || echo "Build size check failed"
#         fi

#     - name: Deploy and restart PM2
#       run: |
#         echo "Current directory: $(pwd)"
#         echo "Restarting PM2 process..."
#         pm2 restart 0 --update-env
#         pm2 save
#         echo "PM2 status:"
#         pm2 status

#     - name: Health check
#       run: |
#         sleep 5
#         curl -f http://localhost:3000/api/health || echo "Health check endpoint not available"
#       continue-on-error: true

name: Node.js CI

on:
  push:
    branches: [ 'main' ]
  pull_request:
    branches: [ 'main' ]

jobs:
  build:
    runs-on: self-hosted
    timeout-minutes: 25

    strategy:
      matrix:
        node-version: [ 22.x ]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Use Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}

    # Use local caching instead of GitHub Actions cache for self-hosted runners
    - name: Setup local cache directories
      run: |
        mkdir -p ~/.npm-cache
        mkdir -p ~/.next-cache
        npm config set cache ~/.npm-cache

    - name: Check for existing node_modules
      id: node_modules_check
      run: |
        if [ -d "node_modules" ] && [ -f "package-lock.json" ]; then
          PACKAGE_HASH=$(sha256sum package-lock.json | cut -d' ' -f1)
          STORED_HASH_FILE="~/.npm-cache/package-lock.hash"
          
          if [ -f "$STORED_HASH_FILE" ] && [ "$(cat $STORED_HASH_FILE)" = "$PACKAGE_HASH" ]; then
            echo "dependencies_changed=false" >> $GITHUB_OUTPUT
            echo "Dependencies unchanged, skipping install"
          else
            echo "dependencies_changed=true" >> $GITHUB_OUTPUT
            echo "$PACKAGE_HASH" > "$STORED_HASH_FILE"
            echo "Dependencies changed, will reinstall"
          fi
        else
          echo "dependencies_changed=true" >> $GITHUB_OUTPUT
          echo "No node_modules found, will install"
        fi

    - name: Install dependencies
      if: steps.node_modules_check.outputs.dependencies_changed == 'true'
      run: |
        npm ci --prefer-offline --no-audit --progress=false
        echo "$(sha256sum package-lock.json | cut -d' ' -f1)" > ~/.npm-cache/package-lock.hash

    - name: Restore Next.js cache
      run: |
        if [ -d ~/.next-cache ]; then
          cp -r ~/.next-cache .next/cache 2>/dev/null || mkdir -p .next/cache
          echo "Next.js cache restored"
        else
          mkdir -p ~/.next-cache
          mkdir -p .next/cache
          echo "Created new Next.js cache directories"
        fi

    # Rest of your workflow steps remain the same...
    - name: Create production environment file
      run: |
        cat > .env.production << EOF
        NEXT_URL=${{ secrets.NEXT_URL }}
        ENCRYPTION_KEY=${{ secrets.ENCRYPTION_KEY }}
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        GOOGLE_CLIENT_ID=${{ secrets.GOOGLE_CLIENT_ID }}
        GOOGLE_CLIENT_SECRET=${{ secrets.GOOGLE_CLIENT_SECRET }}
        NEXTAUTH_SECRET=${{ secrets.NEXTAUTH_SECRET }}
        RESEND_API_KEY=${{ secrets.RESEND_API_KEY }}
        UPLOADTHING_APPID=${{ secrets.UPLOADTHING_APPID }}
        UPLOADTHING_SECRET=${{ secrets.UPLOADTHING_SECRET }}
        UPLOADTHING_TOKEN=${{ secrets.UPLOADTHING_TOKEN }}
        ITS_GITHUB_ID=${{ secrets.ITS_GITHUB_ID }}
        ITS_GITHUB_SECRET=${{ secrets.ITS_GITHUB_SECRET }}
        AUTH_TRUST_HOST=${{ secrets.AUTH_TRUST_HOST }}
        NEXTAUTH_URL=${{ secrets.NEXTAUTH_URL }}
        EOF

    - name: Run database operations
      run: |
        if [ -f "prisma/schema.prisma" ]; then
          npx prisma generate --no-engine
          npx prisma db push --accept-data-loss || echo "Migration skipped"
        fi
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}

    - name: Build Next.js application
      run: npm run build
      env:
        NODE_ENV: production
        NEXT_TELEMETRY_DISABLED: 1

    - name: Save Next.js cache
      run: |
        if [ -d ".next/cache" ]; then
          cp -r .next/cache ~/.next-cache/
          echo "Next.js cache saved"
        fi

    - name: Deploy and restart PM2
      run: |
        echo "Restarting PM2 process..."
        pm2 restart 0 --update-env
        pm2 save
        pm2 status

    - name: Health check
      run: |
        sleep 10
        curl -f http://localhost:3000/api/health || echo "Health check endpoint not available"
      continue-on-error: true
